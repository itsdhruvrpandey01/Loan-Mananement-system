<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Apply for Loan</h2>
        <button class="btn btn-outline-secondary" (click)="goBack()">
          <i class="bi bi-arrow-left"></i> Back to Schemes
        </button>
      </div>

      <!-- Selected Scheme Info -->
      <div *ngIf="selectedScheme" class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> Selected Loan Scheme: {{ selectedScheme.loanName }}
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <small class="text-muted">Amount Range</small>
              <p class="mb-2"><strong>₹{{ selectedScheme.minLoanAmount | number }} - ₹{{ selectedScheme.maxLoanAmount | number }}</strong></p>
            </div>
            <div class="col-md-4">
              <small class="text-muted">Interest Rate</small>
              <p class="mb-2"><strong>{{ selectedScheme.interestRate }}% p.a.</strong></p>
            </div>
            <div class="col-md-4">
              <small class="text-muted">Max Tenure</small>
              <p class="mb-2"><strong>{{ selectedScheme.maxTenure }} months</strong></p>
            </div>
          </div>
          <div *ngIf="selectedScheme.collateralRequired" class="alert alert-warning mb-0 mt-2">
            <i class="bi bi-shield-exclamation"></i> <strong>Note:</strong> This loan requires collateral
          </div>
        </div>
      </div>

      <!-- Application Form -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-1-circle-fill text-primary"></i> Loan Application Details
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="applyLoanForm">
            <div class="row">
              
              <!-- Loan Amount -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Loan Amount <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <input 
                    formControlName="loanAmount" 
                    type="number" 
                    class="form-control"
                    [class.is-invalid]="applyLoanForm.get('loanAmount')?.invalid && applyLoanForm.get('loanAmount')?.touched"
                    placeholder="Enter amount">
                </div>
                <small *ngIf="selectedScheme" class="form-text text-muted">
                  Min: ₹{{ selectedScheme.minLoanAmount | number }}, Max: ₹{{ selectedScheme.maxLoanAmount | number }}
                </small>
                <div *ngIf="applyLoanForm.get('loanAmount')?.invalid && applyLoanForm.get('loanAmount')?.touched" 
                     class="invalid-feedback d-block">
                  Please enter a valid loan amount within the range
                </div>
              </div>

              <!-- Tenure -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Tenure (months) <span class="text-danger">*</span></label>
                <input 
                  formControlName="tenure" 
                  type="number" 
                  class="form-control"
                  [class.is-invalid]="applyLoanForm.get('tenure')?.invalid && applyLoanForm.get('tenure')?.touched"
                  placeholder="Enter tenure in months">
                <small *ngIf="selectedScheme" class="form-text text-muted">
                  Max: {{ selectedScheme.maxTenure }} months
                </small>
                <div *ngIf="applyLoanForm.get('tenure')?.invalid && applyLoanForm.get('tenure')?.touched" 
                     class="invalid-feedback d-block">
                  Please enter a valid tenure
                </div>
              </div>

              <!-- Loan Scheme ID (Readonly if scheme selected, editable otherwise) -->
              <div class="col-md-6 mb-3">
                <!-- <label class="form-label">Loan Scheme ID <span class="text-danger">*</span></label> -->
                <!-- <input 
                  [(ngModel)]="loanSchemeId"
                  formControlName="loanSchemeId" 
                  type="number" 
                  class="form-control"
                  [class.is-invalid]="applyLoanForm.get('loanSchemeId')?.invalid && applyLoanForm.get('loanSchemeId')?.touched"
                  [readonly]="selectedScheme !== null"
                  [class.bg-light]="selectedScheme !== null"
                  placeholder="Enter loan scheme ID"> -->
                <!-- <small *ngIf="selectedScheme" class="text-success"> -->
                  <!-- <i class="bi bi-check-circle-fill"></i> Auto-filled from selected scheme -->
                <!-- </small> -->
                <div *ngIf="applyLoanForm.get('loanSchemeId')?.invalid && applyLoanForm.get('loanSchemeId')?.touched" 
                     class="invalid-feedback d-block">
                  Loan scheme ID is required
                </div>
              </div>

              <!-- Occupation -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Occupation <span class="text-danger">*</span></label>
                <input 
                  formControlName="occupation" 
                  type="text" 
                  class="form-control"
                  [class.is-invalid]="applyLoanForm.get('occupation')?.invalid && applyLoanForm.get('occupation')?.touched"
                  placeholder="e.g., Software Engineer, Teacher">
                <div *ngIf="applyLoanForm.get('occupation')?.invalid && applyLoanForm.get('occupation')?.touched" 
                     class="invalid-feedback d-block">
                  Occupation is required
                </div>
              </div>

              <!-- Monthly Income -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Monthly Income <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <input 
                    formControlName="monthlyIncome" 
                    type="number" 
                    class="form-control"
                    [class.is-invalid]="applyLoanForm.get('monthlyIncome')?.invalid && applyLoanForm.get('monthlyIncome')?.touched"
                    placeholder="Enter monthly income">
                </div>
                <small *ngIf="selectedScheme" class="form-text text-muted">
                  Minimum required: ₹{{ selectedScheme.minIncome | number }}
                </small>
                <div *ngIf="applyLoanForm.get('monthlyIncome')?.invalid && applyLoanForm.get('monthlyIncome')?.touched" 
                     class="invalid-feedback d-block">
                  Please enter a valid monthly income
                </div>
              </div>

              <!-- Applicant Age -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Applicant Age <span class="text-danger">*</span></label>
                <input 
                  formControlName="applicantAge" 
                  type="number" 
                  class="form-control"
                  [class.is-invalid]="applyLoanForm.get('applicantAge')?.invalid && applyLoanForm.get('applicantAge')?.touched"
                  placeholder="Enter your age">
                <small *ngIf="selectedScheme" class="form-text text-muted">
                  Age limit: {{ selectedScheme.minAge }} - {{ selectedScheme.maxAge }} years
                </small>
                <div *ngIf="applyLoanForm.get('applicantAge')?.invalid && applyLoanForm.get('applicantAge')?.touched" 
                     class="invalid-feedback d-block">
                  Please enter a valid age within the allowed range
                </div>
              </div>

            </div>

            <div class="d-grid">
              <button 
                type="button" 
                class="btn btn-primary btn-lg" 
                [disabled]="applyLoanForm.invalid || applicationCreated || isSubmitting"
                (click)="applyForLoan()">
                <span *ngIf="!isSubmitting">
                  <i class="bi bi-check-circle"></i> Submit Application
                </span>
                <span *ngIf="isSubmitting">
                  <span class="spinner-border spinner-border-sm me-2"></span> Submitting...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Document Upload Section -->
      <div *ngIf="requiredDocuments.length > 0" class="card shadow-sm">
        <div class="card-header" [class.bg-light]="!applicationCreated" [class.bg-success]="applicationCreated" [class.text-white]="applicationCreated">
          <h5 class="mb-0">
            <i class="bi bi-2-circle-fill" [class.text-primary]="!applicationCreated" [class.text-white]="applicationCreated"></i> 
            Required Documents
            <span *ngIf="!applicationCreated" class="badge bg-warning text-dark float-end">Complete Step 1 First</span>
            <span *ngIf="applicationCreated" class="badge bg-light text-dark float-end">Ready to Upload</span>
          </h5>
        </div>
        <div class="card-body">
          
          <div *ngIf="!applicationCreated" class="alert alert-info">
            <i class="bi bi-info-circle"></i> Please submit the application form above first, then you can upload the required documents.
          </div>

          <div *ngIf="applicationCreated" class="alert alert-success">
            <i class="bi bi-check-circle"></i> Application submitted successfully! Application ID: <strong>{{ applicationId }}</strong>
            <br>Now please upload all required documents below.
          </div>

          <!-- Document Upload List -->
          <div class="list-group mb-3">
            <div 
              *ngFor="let doc of documentUploads; let i = index" 
              class="list-group-item"
              [class.list-group-item-success]="doc.file">
              
              <div class="row align-items-center">
                <div class="col-md-4">
                  <strong>
                    <i class="bi bi-file-earmark-text me-2"></i>{{ doc.docType }}
                  </strong>
                  <span class="text-danger">*</span>
                </div>
                
                <div class="col-md-5">
                  <input 
                    type="file" 
                    class="form-control form-control-sm" 
                    [id]="'file-' + i"
                    [disabled]="!applicationCreated"
                    (change)="onFileSelected($event, i)"
                    accept=".pdf,.jpg,.jpeg,.png">
                  <small *ngIf="doc.fileName" class="text-success">
                    <i class="bi bi-check-circle-fill"></i> {{ doc.fileName }}
                  </small>
                </div>
                
                <div class="col-md-3 text-end">
                  <button 
                    *ngIf="doc.file" 
                    class="btn btn-sm btn-outline-danger"
                    (click)="removeFile(i)">
                    <i class="bi bi-trash"></i> Remove
                  </button>
                  <span *ngIf="!doc.file" class="badge bg-secondary">Not uploaded</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Upload Button -->
          <div class="d-grid">
            <button 
              type="button" 
              class="btn btn-success btn-lg" 
              [disabled]="!applicationCreated || !allDocumentsUploaded() || isSubmitting"
              (click)="uploadDocuments()">
              <span *ngIf="!isSubmitting">
                <i class="bi bi-cloud-upload"></i> Upload All Documents & Complete Application
              </span>
              <span *ngIf="isSubmitting">
                <span class="spinner-border spinner-border-sm me-2"></span> Uploading...
              </span>
            </button>
          </div>

          <small class="text-muted d-block mt-2 text-center">
            <i class="bi bi-info-circle"></i> Accepted formats: PDF, JPG, JPEG, PNG (Max 5MB per file)
          </small>
        </div>
      </div>

    </div>
  </div>
</div>